@using System.Linq
@using Imobiliare.UI.BusinessLayer
@using Imobiliare.Entities
@using Imobiliare.UI.Utils.UrlSeoFormatters
@model Imobiliare.UI.Models.ImobilsData

@helper DisplayAnunt(Imobil anunt, string anuntUrl, List<string> anunturiSalvate)
{
<div class="anuntBox row" style="box-shadow: 0 2px 8px 0 #888888; margin-bottom: 15px; @(anunt.PromotedLevel > PromovatLevel.Nepromovat ? "background-color:#EEFFE0" : "")">
    <div class="col-sm-5" style="padding: 0">
        @if (TipOfertaOptions.OptionVisible(AnuntOptiuni.Imagini, anunt.TipProprietate, anunt.TipOfertaGen))
        {
            <div style="display: inline-block; position: relative; width: 100%">
                
                <img class="center-cropped" style="max-height: 190px; cursor: pointer" onclick="window.location = '@anuntUrl'" alt="@HtmlHelpers.RemoveSpecialCharacters(anunt.Title, ' ', false)"
                     src="~/Images/uploadedPhotos/@anunt.FirstPhoto" />
                @if (anunt.Poze != null)
                {
                    <div style="position: absolute; top: 7px; left: 8px; opacity: 0.8; width: 40px; background-color: #fff; font-weight: bold; font-size: 11px;">
                        <span style="padding-left: 7px" class="glyphicon glyphicon-camera"></span>
                        <b style="padding-left: 2px; font-size: 1.2em">@anunt.Poze.Split(';').Count()</b>
                    </div>
                }

                @if (anunt.UserProfile.Agentie != null && !string.IsNullOrEmpty(anunt.UserProfile.Agentie.PozaAgentie) &&
                     anunt.UserProfile.Role != Role.Administrator && anunt.TipVanzator == TipVanzator.AgentieImobiliara)
                {
                    <div style="position: absolute; cursor: pointer; top: 97px; left: 125px; height: 50px; text-align: center;"
                         onclick="var url = '@Url.Action("AnunturiUtilizator", "Anunturi", new {userId = anunt.UserId})';window.location = url;">
                        <img class="img-thumbnail" style="max-height: 40px; max-width: 50px; vertical-align: middle;" src="~/Images/LogoAgentii/@anunt.UserProfile.Agentie.PozaAgentie" alt="agentie imobiliara logo" />
                    </div>
                }


            </div>
        }
    </div>

    <div class="col-xs-12 col-sm-7" style="padding-left: 0; padding-right: 0; overflow: hidden">
        <div style="padding-left: 0; padding-right: 0;">
            <div class="col-xs-12 col-sm-8" style="white-space: nowrap; overflow: hidden; cursor: pointer">
                <a class="anchor-link-spanner" href="@anuntUrl">

                    @if (anunt.DataAdaugareInitiala.AddDays(14) > DateTime.Now)
                    {
                        <span class="label label-success">nou</span>
                    }



                    @if (anunt.PromotedLevel > PromovatLevel.Nepromovat)
                    {
                        <span class="label label-success"><span class="glyphicon glyphicon-star"></span>promovat</span>
                    }


                    <h3 style="margin-top: 8px; display: inline-block" title="@anunt.Title">@TipOfertaDisplayFormatter.GetDisplayString(anunt.TipProprietate, anunt.TipOfertaGen): @anunt.Title</h3>
                </a>
            </div>
            <h2 class="hidden-xs" style="margin-top: 8px; text-align: right; padding-right: 12px">@Html.DisplayFor(model => anunt.Price) €</h2>
        </div>

        <div class="col-xs-12" style="padding-left: 0; padding-right: 0; background-color: rgba(255, 255, 255, 0.9)">
            <div class="col-xs-8" style="padding-right: 0">
                <div style="white-space: nowrap; overflow: hidden">
                    <p style="margin-bottom: 3px; margin-top: 3px">
                        @Html.DisplayFor(model => anunt.Judet.Nume), @Html.DisplayFor(model => anunt.Oras.Nume)
                        @if (anunt.Cartier != null)
                        {
                            @:, @Html.DisplayFor(model => anunt.Cartier.Nume)
                        }
                    </p>

                    @if (anunt.TipVanzator == TipVanzator.PersoanaFizica)
                    {
                        <p style="margin: 5px 0 0 0; overflow: hidden; white-space: nowrap">Persoană Fizică</p>
                    }
                    else
                    {
                        if (anunt.TipVanzator == TipVanzator.AgentieImobiliara)
                        {
                            <p style="margin: 5px 0 0 0; overflow: hidden; white-space: nowrap">Ag imobiliară</p>
                        }
                        else if (anunt.TipVanzator == TipVanzator.Constructor)
                        {
                            <p style="margin: 5px 0 0 0; overflow: hidden; white-space: nowrap">Constructor</p>
                        }
                    }


                </div>
            </div>

            <div class="col-xs-4" style="text-align: right; padding-left: 0">
                <h3 class="visible-xs" style="margin-top: 3px">@Html.DisplayFor(model => anunt.Price) €</h3>
                <p style="margin-bottom: 3px; margin-top: 3px">
                    <b>@Html.DisplayFor(model => anunt.Suprafata)</b> MP
                </p>


                @if (TipOfertaOptions.OptionVisible(AnuntOptiuni.NumarCamere, anunt.TipProprietate, anunt.TipOfertaGen) &&
                     anunt.NumarCamere > 0)
                {
                    <p style="margin-bottom: 3px; margin-top: 3px">
                        <b>@Html.DisplayFor(model => anunt.NumarCamere) Camere</b>
                    </p>
                }


            </div>
        </div>

        <div class="col-xs-12 descriereApartament" style="padding-top: 5px; padding-left: 0; padding-right: 0; background-color: rgba(255, 255, 255, 0.9)">
            <p style="display: none" class="imobilIdClass">@anunt.Id</p>
            <div class="ascundeDiv hidden-xs col-sm-3" style="cursor: pointer" title="Ascunde anunț">
                <span class="glyphicon glyphicon glyphicon-remove"></span>
                <p style="display: inline-block; font-size: 1.2em; font-weight: bold; margin: 5px 5px 5px 0">Ascunde</p>
            </div>
            <div class="salveazaAnunt col-xs-6 col-sm-3" style="cursor: pointer">

                @if (anunturiSalvate.Contains(anunt.Id.ToString()))
                {
                    <span class="glyphicon glyphicon-heart red"></span>
                    <p style="display: inline-block; font-size: 1.2em; font-weight: bold; margin: 5px 5px 5px 0">Salvat</p>
                }
                else
                {
                    <span class="glyphicon glyphicon-heart"></span>
                    <p style="display: inline-block; font-size: 1.2em; font-weight: bold; margin: 5px 5px 5px 0">Salvează</p>
                }


            </div>
            <div class="previzualizeaza hidden-xs col-xs-6 col-sm-3" style="cursor: pointer; padding-right: 0; padding-left: 0">
                <img width="20px" class="arrowState" src="~/Images/arrRight.png" alt="Arata detalii anunt" />
                <p style="display: inline-block; font-size: 1.2em; font-weight: bold; margin-top: 5px">Vizualizare</p>
            </div>
            <a style="float: right; margin-top: 0" class="actionLinkButton col-sm-3" href="@anuntUrl">Detalii</a>
        </div>

    </div>
    <div class="previzualizare" style="border-top: 1px solid rgb(220, 220, 220); padding-top: 5px">
        <div style="display: inline-block; width: 200px; vertical-align: top; padding: 5px 0 0 10px">

            @if (anunt.Negociabil)
            {
                <img class="checkboxBool" src="~/Images/right3.png" />
                <p style="display: inline">Negociabil</p>
                <br />
            }




            @if (anunt.AerConditionat)
            {
                <img class="checkboxBool" src="~/Images/right3.png" />
                <p style="display: inline">Aer Conditionat</p>
                <br />
            }




            @if (anunt.CT)
            {
                <img class="checkboxBool" src="~/Images/right3.png" />
                <p style="display: inline">Centrala termica</p>
                <br />
            }




            @if (anunt.Garaj)
            {
                <img class="checkboxBool" src="~/Images/right3.png" />
                <p style="display: inline">Garaj</p>
                <br />
            }




            @if (anunt.LocParcare)
            {
                <img class="checkboxBool" src="~/Images/right3.png" />
                <p style="display: inline">Loc Parcare</p>
                <br />
            }




            @if (anunt.Decomandat)
            {
                <img class="checkboxBool" src="~/Images/right3.png" />
                <p style="display: inline">Decomandat</p>
                <br />
            }




            @if (anunt.Finisat)
            {
                <img class="checkboxBool" src="~/Images/right3.png" />
                <p style="display: inline">Finisat</p>
                <br />
            }




            @if (anunt.LocInPivnita)
            {
                <img class="checkboxBool" src="~/Images/right3.png" />
                <p style="display: inline">Loc In Pivnita</p>
                <br />
            }


        </div>
        <div style="max-width: 280px; display: inline-block">

            @if (anunt.Strada != null)
            {
                <p style="margin: 5px">
                    <b>Adresa:</b> @Html.DisplayFor(model => anunt.Strada)
                </p>
            }



            @if (TipOfertaOptions.OptionVisible(AnuntOptiuni.NumarBalcoane, anunt.TipProprietate, anunt.TipOfertaGen) &&
                 anunt.NrBalcoane != 0)
            {
                string numarBalcoane;
                switch (anunt.NrBalcoane)
                {
                    case 0:
                        numarBalcoane = "Nespecificat";
                        break;
                    case -1:
                        numarBalcoane = "Nu are balcon";
                        break;
                    default:
                        numarBalcoane = anunt.NrBalcoane.ToString();
                        break;
                }

                <p style="margin: 5px">
                    <b>Balcoane:</b> @numarBalcoane
                </p>
            }




            @if (TipOfertaOptions.OptionVisible(AnuntOptiuni.Etaj, anunt.TipProprietate, anunt.TipOfertaGen) &&
                 anunt.Etaj != -4)
            {
                string etaj;
                if (anunt.Etaj == -3)
                {
                    etaj = "Demisol";
                }
                else
                {
                    if (anunt.Etaj == -2)
                    {
                        etaj = "Parter";
                    }
                    else if (anunt.Etaj == -1)
                    {
                        etaj = "Mansarda";
                    }
                    else
                    {
                        etaj = anunt.Etaj.ToString();
                    }
                }

                if (anunt.Etaj != 0)
                {
                    <p style="margin: 5px">
                        <b>Etaj:</b> <b>@etaj</b>
                    </p>
                }
            }




            @if (TipOfertaOptions.OptionVisible(AnuntOptiuni.NumarBai, anunt.TipProprietate, anunt.TipOfertaGen) &&
                 anunt.NrBai != 0)
            {
                <p style="margin: 5px">
                    <b>Bai:</b> @Html.DisplayFor(model => anunt.NrBai)
                </p>
            }



            @if (TipOfertaOptions.OptionVisible(AnuntOptiuni.AnulConstructiei, anunt.TipProprietate, anunt.TipOfertaGen) &&
                 anunt.VechimeImobil != 0)
            {
                <p style="margin: 5px">
                    <b>An constructie:</b> @Html.DisplayFor(model => anunt.VechimeImobil)
                </p>
            }


            <p style="margin: 5px">
                <b>Data:</b> @Html.DisplayFor(model => anunt.DataAdaugare)
            </p>
        </div>
        <div style="max-width: 100%; display: inline-block; vertical-align: top; margin-left: 30px">
            <p style="margin: 5px">
                <b>Descriere:</b>
                @if (anunt.Descriere != null)
                {
                    if (anunt.Descriere.Length < 270)
                    {
                        @Html.DisplayFor(model => anunt.Descriere)
                    }
                    else
                    {
                        @Html.Raw(anunt.Descriere.Substring(0, 270))
                        @:...
                    }
                }


            </p>
        </div>
    </div>

</div>
    <div class="hiddenAnuntBox row" style="display: none; margin-bottom: 10px; border: 1px solid #a7d582; border-radius: 3px;">
        <div class="col-xs-8 col-sm-3">
            <button class="btn btn-success showHiddenAnunt"><span class="glyphicon glyphicon-eye-open"></span> Arată Anunț</button>
        </div>
        <div class="col-xs-12 col-sm-5">
            <p style="white-space: nowrap; overflow: hidden">
                <b>@TipOfertaDisplayFormatter.GetDisplayString(anunt.TipProprietate, anunt.TipOfertaGen): @anunt.Title</b>
            </p>
        </div>
        <div class="col-xs-12 col-sm-4">
            <p>
                <b>@anunt.Price Euro</b>
            </p>
        </div>
    </div>
    <div class="visible-xs" style="height: 10px"></div>
}

@if (Model.Imobils.Any())
{
    var anunturiSalvate = new List<string>();
    var anunturiSalvateCookie = Request.Cookies["AnunturiSalvate"];
    if (anunturiSalvateCookie != null)
    {
        var formattedCookie = anunturiSalvateCookie.Value.Replace("%2C", ",");
        anunturiSalvate = new List<string>(formattedCookie.Split(','));
    }

    var randomPromovatedAnunturiIndex = 0;
    if (Model.PromovatedImobils.Count > 0)
    {
        randomPromovatedAnunturiIndex = new Random().Next(0, Model.Imobils.Count);
    }

    foreach (var anunt in Model.Imobils)
    {
        var anuntUrl = UrlBuilder.BuildAnuntPageUrl(anunt.Oras.Nume, anunt.TipProprietate, anunt.TipOfertaGen, anunt.Title, anunt.Id);
        //Show google ad inline if more than 6 anunturi at position 5
        var index = Model.Imobils.FindIndex(a => a == anunt);
        if (Model.Imobils.Count > 6 && index == 5)
        {
            <div style="margin: 20px 0">
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Ap 25 Reclama anunturi / categorii -->
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-1474334984782094"
                     data-ad-slot="5459285763"
                     data-ad-format="auto"></ins>
                <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
        }
        if (Model.PromovatedImobils.Count > 0 && index == randomPromovatedAnunturiIndex)
        {
            foreach (var promoAnunt in Model.PromovatedImobils)
            {
                anuntUrl = UrlBuilder.BuildAnuntPageUrl(promoAnunt.Oras.Nume, promoAnunt.TipProprietate, promoAnunt.TipOfertaGen, promoAnunt.Title, promoAnunt.Id);
                @DisplayAnunt(promoAnunt, anuntUrl, anunturiSalvate)
            }
        }

        bool any = false;
        foreach (var x in Model.PromovatedImobils)
        {
            if (x.Id == anunt.Id)
            {
                any = true;
                break;
            }
        }
        if (!(any))
        {
            @DisplayAnunt(anunt, anuntUrl, anunturiSalvate)
        }
    }
}
else
{
    <h3 class="alert alert-warning">Nu exista anunturi pentru criteriile selectate.</h3>
    <br />

    var numarAnunturi = 0;
    foreach (var oras in Model.TotalSelectableOrasesWithNumber)
    {
        numarAnunturi += oras.Value;
    }
    var judet = Model.Judets.First(x => x.Id == Model.ImobilFilter.JudetId);
    var judetName = judet.Nume;
    if (Model.TotalSelectableOrasesWithNumber.Count(x => x.Value != 0) != 0)
    {
        @Html.ActionLink("Arată toate anunțurile pentru județul " + @judetName + " (" + @numarAnunturi + ")", "SelectJudet", "Home", new { judetName = @judetName }, new { @class = "actionLinkButton" })
        <br />
        <br />
        foreach (var oras in Model.TotalSelectableOrasesWithNumber.OrderByDescending(x => x.Value).Where(x => x.Value > 0))
        {
            @*<h3>@Html.ActionLink(@oras.Key.Nume + " (" + @oras.Value + " Anunturi)", "SearchForValue", "Home", new { searchValue = @oras.Key.Nume + " | " + @judet.PrescurtareAuto, tipOferta1 = "Toate", tipOfertaGen = "Toate" }, new { @class = "needToAddInOrderParameterToWork" })</h3>*@
            <h3><a href="@UrlBuilder.BuildLocalitateUrl(oras.Key.Nume, oras.Key.Judet.Nume)">@oras.Key.Nume <span class="badge">@oras.Value</span> <small>Anunturi</small></a></h3>
        }
    }
    else
    {
        <h3>Nu exista anunturi pentru judetul @judetName.</h3>
        <br />
        <div class="btn btn-success">
            <span class="glyphicon glyphicon-plus-sign"></span>
            @Html.ActionLink("Adauga Anunt Gratuit", "AnuntEditare", "Administrare", null, new { style = "color: white; font-weight: bold; text-decoration: none" })
        </div>
    }
}